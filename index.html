<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Franklin Monsalve - $1.000.000</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .number-grid {
            grid-template-columns: repeat(5, 1fr);
        }
        @media (min-width: 640px) {
            .number-grid {
                grid-template-columns: repeat(10, 1fr);
            }
        }
        .number-button {
            min-height: 44px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
            100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
        }
        .file-input {
            display: none;
        }
        .file-label {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-label:hover {
            transform: scale(1.05);
        }
        .responsive-grid {
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        }
        .responsive-button {
            min-width: 60px;
            min-height: 60px;
            font-size: 0.875rem;
        }
        @media (max-width: 380px) {
            .responsive-button {
                min-width: 50px;
                min-height: 50px;
                font-size: 0.75rem;
            }
        }
        .form-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .form-buttons {
                flex-direction: row;
            }
        }
        .required-field::after {
            content: " *";
            color: #ef4444;
        }
        .expired-reservation {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52) !important;
            border-color: #dc2626 !important;
            animation: pulse-expired 2s infinite;
        }
        @keyframes pulse-expired {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        .pending-verification {
            background: linear-gradient(45deg, #f59e0b, #d97706) !important;
            border-color: #f59e0b !important;
            animation: pulse-pending 2s infinite;
        }
        @keyframes pulse-pending {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-purple-800 to-indigo-900 min-h-screen">
    <div id="app"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { jsPDF } = window.jspdf;

        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAGC_fsHfnguY4m0o2OE3SLSanDGk39zbM",
            authDomain: "rifa-franklin.firebaseapp.com",
            projectId: "rifa-franklin",
            storageBucket: "rifa-franklin.firebasestorage.app",
            messagingSenderId: "451592144799",
            appId: "1:451592144799:web:7ea7a0e85a6579f8b69faa",
            measurementId: "G-Q4XVNYKVWB"
        };

        // Inicializar Firebase solo una vez
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        function TalonarioRifa() {
            const [selectedNumbers, setSelectedNumbers] = useState(new Set());
            const [soldNumbers, setSoldNumbers] = useState(new Set());
            const [showTicket, setShowTicket] = useState(false);
            const [currentTicket, setCurrentTicket] = useState(null);
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                nombre: '',
                apellido: '',
                telefono: '',
                email: '',
                metodoPago: '',
                comprobanteFile: null
            });
            const [ticketData, setTicketData] = useState({});
            const [pendingNumbers, setPendingNumbers] = useState(new Set());
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [lastSale, setLastSale] = useState(null);
            const [syncStatus, setSyncStatus] = useState('üü° Conectando...');
            const [reservedNumbers, setReservedNumbers] = useState(new Set());
            const [showDrawPanel, setShowDrawPanel] = useState(false);
            const [winnerNumber, setWinnerNumber] = useState(null);
            const [drawExecuted, setDrawExecuted] = useState(false);
            const [ticketCounter, setTicketCounter] = useState(1);
            const [isUploading, setIsUploading] = useState(false);
            const [showUpdatePaymentModal, setShowUpdatePaymentModal] = useState(false);
            const [selectedReservedNumber, setSelectedReservedNumber] = useState(null);
            const [updatePaymentData, setUpdatePaymentData] = useState({
                metodoPago: '',
                comprobanteFile: null
            });
            const [paymentConfirmed, setPaymentConfirmed] = useState(false);
            const [showClearDataModal, setShowClearDataModal] = useState(false);
            const [clearDataConfirmation, setClearDataConfirmation] = useState('');
            const [showSearchTicketModal, setShowSearchTicketModal] = useState(false);
            const [searchPhone, setSearchPhone] = useState('');
            const [foundTickets, setFoundTickets] = useState([]);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [appSettings, setAppSettings] = useState({
                fechaSorteo: '23 de Diciembre',
                loteria: 'Chance Pick 3 Noche',
                precioNumero: 25000,
                fechaLimitePago: new Date(2024, 11, 23, 12, 0, 0).getTime()
            });
            const [expiredReservations, setExpiredReservations] = useState(new Set());
            const [pendingVerificationNumbers, setPendingVerificationNumbers] = useState(new Set());
            const [showPaymentInstructions, setShowPaymentInstructions] = useState(false);
            const [currentPaymentData, setCurrentPaymentData] = useState({
                metodoPago: '',
                numeros: [],
                total: 0,
                isUpdate: false
            });

            const ADMIN_PASSWORD = "Franklin2024";
            const db = firebase.firestore();
            const storage = firebase.storage();

            // Funci√≥n para abrir apps de pago
            const openPaymentApp = (metodoPago, total) => {
                let appUrl = '';
                let fallbackUrl = '';
                
                switch(metodoPago) {
                    case 'nequi':
                        appUrl = "nequi://pago?telefono=3197118858&monto=" + total;
                        fallbackUrl = "https://api.whatsapp.com/send?phone=573197118858&text=" + 
                            encodeURIComponent(`Hola Franklin, quiero pagar mi boleta de rifa por Nequi. Monto: $${total}`);
                        break;
                        
                    case 'bancolombia':
                        appUrl = "bancolombia://transfer?codigo=31172084632&monto=" + total;
                        fallbackUrl = "https://api.whatsapp.com/send?phone=573197118858&text=" + 
                            encodeURIComponent(`Hola Franklin, quiero pagar mi boleta de rifa por Bancolombia. Monto: $${total}`);
                        break;
                        
                    case 'efectivo':
                        appUrl = "https://api.whatsapp.com/send?phone=573197118858&text=" + 
                            encodeURIComponent(`Hola Franklin, quiero coordinar pago en efectivo para mi boleta de rifa. Monto: $${total}`);
                        break;
                        
                    case 'transferencia':
                        appUrl = "https://api.whatsapp.com/send?phone=573197118858&text=" + 
                            encodeURIComponent(`Hola Franklin, quiero realizar transferencia para mi boleta de rifa. Monto: $${total}`);
                        break;
                        
                    default:
                        return false;
                }
                
                // Intentar abrir la app nativa
                window.location.href = appUrl;
                
                // Si no se abre la app, redirigir a WhatsApp despu√©s de un tiempo
                setTimeout(() => {
                    if (!document.hidden) {
                        window.open(fallbackUrl, '_blank');
                    }
                }, 1000);
                
                return true;
            };

            // Funci√≥n para procesar pago con app
            const processPaymentWithApp = async (e, isUpdate = false) => {
                e.preventDefault();
                
                const metodoPago = isUpdate ? updatePaymentData.metodoPago : formData.metodoPago;
                const total = isUpdate ? appSettings.precioNumero : (appSettings.precioNumero * selectedNumbers.size);
                
                if (!metodoPago) {
                    alert('‚ùå Por favor selecciona un m√©todo de pago');
                    return;
                }

                // Validar campos obligatorios para nuevo pago
                if (!isUpdate && (!formData.nombre || !formData.telefono || !formData.email)) {
                    alert('‚ùå Por favor completa todos los campos obligatorios (Nombre, Tel√©fono y Email)');
                    return;
                }

                // Guardar datos actuales
                setCurrentPaymentData({
                    metodoPago: metodoPago,
                    numeros: isUpdate ? [selectedReservedNumber] : Array.from(selectedNumbers),
                    total: total,
                    isUpdate: isUpdate
                });

                // Abrir app de pago
                const appOpened = openPaymentApp(metodoPago, total);
                
                if (!appOpened) {
                    alert('‚ùå M√©todo de pago no v√°lido');
                    return;
                }

                // Mostrar instrucciones
                if (!isUpdate) {
                    setShowForm(false);
                } else {
                    setShowUpdatePaymentModal(false);
                }
                setShowPaymentInstructions(true);
            };

            // Funci√≥n para completar el pago despu√©s de usar la app
            const completePaymentAfterApp = async (comprobanteFile) => {
                if (!comprobanteFile) {
                    alert('‚ùå Por favor sube el comprobante de pago');
                    return;
                }

                setIsUploading(true);
                
                try {
                    let ticketInfo;
                    let ticketNumber;
                    
                    if (currentPaymentData.isUpdate) {
                        // Pago desde actualizaci√≥n de reserva
                        ticketInfo = ticketData[selectedReservedNumber];
                        ticketNumber = ticketInfo.ticketNumber;
                    } else {
                        // Pago desde formulario nuevo
                        ticketNumber = `TK-${ticketCounter.toString().padStart(5, '0')}`;
                        ticketInfo = {
                            ...formData,
                            fecha: new Date().toLocaleString('es-CO'),
                            numeros: Array.from(selectedNumbers),
                            ticketNumber,
                            timestamp: new Date().getTime(),
                            verificadoPorAdmin: false
                        };
                    }

                    // Subir comprobante
                    const comprobanteURL = await uploadComprobante(comprobanteFile, ticketNumber);
                    
                    if (!comprobanteURL) {
                        alert('‚ùå Error al subir el comprobante. Int√©ntalo de nuevo.');
                        return;
                    }

                    const updatedTicketInfo = {
                        ...ticketInfo,
                        estado: 'pendiente_verificacion',
                        metodoPago: currentPaymentData.metodoPago,
                        fechaPago: new Date().toLocaleString('es-CO'),
                        timestampPago: new Date().getTime(),
                        comprobanteURL: comprobanteURL,
                        verificadoPorAdmin: false
                    };

                    if (currentPaymentData.isUpdate) {
                        // Actualizar reserva existente
                        const newTicketData = { ...ticketData, [selectedReservedNumber]: updatedTicketInfo };
                        const newPendingVerification = new Set([...pendingVerificationNumbers, selectedReservedNumber]);
                        const newReserved = new Set(reservedNumbers);
                        newReserved.delete(selectedReservedNumber);

                        setTicketData(newTicketData);
                        setPendingVerificationNumbers(newPendingVerification);
                        setReservedNumbers(newReserved);

                        localStorage.setItem('rifaTicketData', JSON.stringify(newTicketData));

                        await db.collection('rifa').doc('tickets').set({ [selectedReservedNumber]: updatedTicketInfo }, { merge: true });
                        await db.collection('rifa').doc('reserved').update({ [selectedReservedNumber]: firebase.firestore.FieldValue.delete() });

                        setLastSale({
                            numero: selectedReservedNumber,
                            cliente: ticketInfo.nombre + (ticketInfo.apellido ? ' ' + ticketInfo.apellido : ''),
                            telefono: ticketInfo.telefono,
                            metodoPago: currentPaymentData.metodoPago,
                            timestamp: new Date().getTime(),
                            tipo: 'actualizaci√≥n_pendiente'
                        });
                    } else {
                        // Nuevo pago
                        const newTicketData = { ...ticketData };
                        const newPendingVerification = new Set([...pendingVerificationNumbers, ...selectedNumbers]);

                        selectedNumbers.forEach(num => {
                            newTicketData[num] = updatedTicketInfo;
                        });

                        setTicketData(newTicketData);
                        setPendingVerificationNumbers(newPendingVerification);
                        setSelectedNumbers(new Set());
                        setPendingNumbers(new Set());

                        localStorage.setItem('rifaTicketData', JSON.stringify(newTicketData));

                        await db.collection('rifa').doc('tickets').set(newTicketData);
                        await db.collection('rifa').doc('metadata').set({ ticketCounter: ticketCounter + 1 }, { merge: true });

                        setTicketCounter(ticketCounter + 1);

                        setLastSale({
                            numeros: Array.from(updatedTicketInfo.numeros),
                            cliente: formData.nombre + (formData.apellido ? ' ' + formData.apellido : ''),
                            telefono: formData.telefono,
                            metodoPago: currentPaymentData.metodoPago,
                            timestamp: new Date().getTime(),
                            tipo: 'pendiente_verificacion'
                        });

                        setCurrentTicket(updatedTicketInfo.numeros[0]);
                    }

                    // Notificar al cliente
                    const confirmationMessage = `üéüÔ∏è *SOLICITUD DE VERIFICACI√ìN - RIFA $1.000.000* üéüÔ∏è\n\n` +
                        `¬°Hola ${ticketInfo.nombre}! Hemos recibido tu comprobante de pago.\n\n` +
                        `üë§ *Titular:* ${ticketInfo.nombre} ${ticketInfo.apellido || ''}\n` +
                        `üéØ *Tu${currentPaymentData.isUpdate ? ' N√∫mero' : 's N√∫meros'}:* ${currentPaymentData.isUpdate ? 
                            selectedReservedNumber.toString().padStart(3, '0') : 
                            Array.from(selectedNumbers).map(n => n.toString().padStart(3, '0')).join(', ')}\n` +
                        `üé´ *Ticket No:* ${ticketInfo.ticketNumber}\n` +
                        `üìã *Estado:* ‚è≥ PENDIENTE DE VERIFICACI√ìN\n\n` +
                        `Tu pago ser√° verificado por el administrador en las pr√≥ximas horas.\n\n` +
                        `¬°Mucha suerte! üçÄ`;

                    window.open(`https://wa.me/57${ticketInfo.telefono}?text=${encodeURIComponent(confirmationMessage)}`, '_blank');

                    // Notificar al administrador
                    const adminMessage = `üîî *NUEVA SOLICITUD DE VERIFICACI√ìN* üîî\n\n` +
                        `üë§ *Cliente:* ${ticketInfo.nombre} ${ticketInfo.apellido || ''}\n` +
                        `üì± *Tel√©fono:* ${ticketInfo.telefono}\n` +
                        `üéØ *${currentPaymentData.isUpdate ? 'N√∫mero' : 'N√∫meros'}:* ${currentPaymentData.isUpdate ? 
                            selectedReservedNumber.toString().padStart(3, '0') : 
                            Array.from(selectedNumbers).map(n => n.toString().padStart(3, '0')).join(', ')}\n` +
                        `üí∞ *M√©todo Pago:* ${currentPaymentData.metodoPago}\n` +
                        `üíµ *Monto:* $${currentPaymentData.total}\n` +
                        `üïí *Fecha:* ${new Date().toLocaleString('es-CO')}\n\n` +
                        `üìé *Comprobante:* ${comprobanteURL}\n\n` +
                        `Por favor verifica el pago en el panel de administraci√≥n.`;

                    window.open(`https://wa.me/573197118858?text=${encodeURIComponent(adminMessage)}`, '_blank');

                    setShowPaymentInstructions(false);
                    setShowTicket(true);
                    
                    alert('‚úÖ Comprobante enviado para verificaci√≥n. El administrador revisar√° tu pago.');

                } catch (error) {
                    console.error('Error procesando el pago:', error);
                    alert('‚ùå Error al procesar el pago. Int√©ntalo de nuevo.');
                } finally {
                    setIsUploading(false);
                }
            };

            // Funci√≥n para verificar si una reserva ha expirado
            const isReservationExpired = (timestamp) => {
                const now = new Date().getTime();
                return now > appSettings.fechaLimitePago;
            };

            // Funci√≥n para verificar y limpiar reservas expiradas
            const checkAndClearExpiredReservations = async () => {
                const now = new Date().getTime();
                if (now > appSettings.fechaLimitePago) {
                    const expired = new Set();
                    const newReservedNumbers = new Set(reservedNumbers);
                    const newTicketData = { ...ticketData };
                    
                    // Buscar reservas expiradas
                    reservedNumbers.forEach(num => {
                        const ticketInfo = ticketData[num];
                        if (ticketInfo && ticketInfo.estado === 'reservado') {
                            expired.add(num);
                            newReservedNumbers.delete(num);
                            delete newTicketData[num];
                        }
                    });
                    
                    if (expired.size > 0) {
                        setExpiredReservations(expired);
                        setReservedNumbers(newReservedNumbers);
                        setTicketData(newTicketData);
                        
                        // Actualizar Firebase
                        const reservedUpdate = {};
                        expired.forEach(num => {
                            reservedUpdate[num] = firebase.firestore.FieldValue.delete();
                        });
                        
                        await db.collection('rifa').doc('reserved').update(reservedUpdate);
                        await db.collection('rifa').doc('tickets').set(newTicketData);
                        
                        // Limpiar localStorage
                        localStorage.setItem('rifaTicketData', JSON.stringify(newTicketData));
                        
                        console.log(`Se liberaron ${expired.size} reservas expiradas`);
                    }
                }
            };

            useEffect(() => {
                loadLocalData();
                setupFirebaseListeners();
                
                // Verificar reservas expiradas cada minuto
                const interval = setInterval(() => {
                    checkAndClearExpiredReservations();
                }, 60000);
                
                return () => clearInterval(interval);
            }, []);

            const loadLocalData = () => {
                const savedSoldNumbers = localStorage.getItem('rifaSoldNumbers');
                const savedTicketData = localStorage.getItem('rifaTicketData');
                const savedAdmin = localStorage.getItem('rifaAdmin');
                const savedSettings = localStorage.getItem('rifaSettings');
                
                if (savedSoldNumbers) setSoldNumbers(new Set(JSON.parse(savedSoldNumbers)));
                if (savedTicketData) setTicketData(JSON.parse(savedTicketData));
                if (savedAdmin) setIsAdmin(JSON.parse(savedAdmin));
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    // Asegurar que la fecha l√≠mite est√© configurada
                    if (!settings.fechaLimitePago) {
                        settings.fechaLimitePago = new Date(2024, 11, 23, 12, 0, 0).getTime();
                    }
                    setAppSettings(settings);
                }
                
                // Verificar reservas expiradas al cargar
                checkAndClearExpiredReservations();
            };

            const setupFirebaseListeners = () => {
                db.collection('rifa').doc('numbers')
                    .onSnapshot((doc) => {
                        const data = doc.data() || {};
                        const soldSet = new Set(Object.keys(data).map(Number));
                        setSoldNumbers(soldSet);
                        setSyncStatus('üü¢ CONECTADO - Tiempo Real');
                    }, (error) => {
                        setSyncStatus('üî¥ Error: ' + error.message);
                    });

                db.collection('rifa').doc('tickets')
                    .onSnapshot((doc) => {
                        const data = doc.data() || {};
                        setTicketData(data);
                        
                        // Actualizar n√∫meros pendientes de verificaci√≥n
                        const pending = new Set();
                        Object.entries(data).forEach(([numero, ticketInfo]) => {
                            if (ticketInfo.estado === 'pendiente_verificacion') {
                                pending.add(parseInt(numero));
                            }
                        });
                        setPendingVerificationNumbers(pending);
                    });

                db.collection('rifa').doc('reserved')
                    .onSnapshot((doc) => {
                        const data = doc.data() || {};
                        setReservedNumbers(new Set(Object.keys(data).map(Number)));
                    });

                db.collection('rifa').doc('draw')
                    .onSnapshot((doc) => {
                        const data = doc.data() || {};
                        if (data.winner !== undefined) {
                            setWinnerNumber(data.winner);
                            setDrawExecuted(true);
                        }
                    });

                db.collection('rifa').doc('metadata')
                    .onSnapshot((doc) => {
                        const data = doc.data() || {};
                        if (data.ticketCounter !== undefined) {
                            setTicketCounter(data.ticketCounter);
                        }
                    });

                db.collection('rifa').doc('settings')
                    .onSnapshot((doc) => {
                        const data = doc.data() || {};
                        if (data.fechaSorteo || data.loteria || data.precioNumero) {
                            // Mantener la fecha l√≠mite si ya existe
                            const fechaLimitePago = data.fechaLimitePago || appSettings.fechaLimitePago;
                            setAppSettings(prev => ({
                                ...prev,
                                ...data,
                                fechaLimitePago
                            }));
                            localStorage.setItem('rifaSettings', JSON.stringify({
                                ...appSettings,
                                ...data,
                                fechaLimitePago
                            }));
                        }
                    });
            };

            // Funci√≥n para subir comprobante a Firebase Storage
            const uploadComprobante = async (file, ticketNumber) => {
                if (!file) return null;
                
                try {
                    const storageRef = storage.ref();
                    const comprobanteRef = storageRef.child(`comprobantes/${ticketNumber}_${Date.now()}_${file.name}`);
                    const snapshot = await comprobanteRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    return downloadURL;
                } catch (error) {
                    console.error('Error subiendo comprobante:', error);
                    return null;
                }
            };

            const openSearchTicketModal = () => {
                setShowSearchTicketModal(true);
                setSearchPhone('');
                setFoundTickets([]);
            };

            const searchTicketByPhone = () => {
                if (!searchPhone || searchPhone.length < 7) {
                    alert('Por favor ingresa un n√∫mero de tel√©fono v√°lido (m√≠nimo 7 d√≠gitos)');
                    return;
                }

                const found = [];
                const phoneDigits = searchPhone.replace(/\D/g, '');

                Object.entries(ticketData).forEach(([numero, data]) => {
                    const ticketPhoneDigits = (data.telefono || '').replace(/\D/g, '');
                    if (ticketPhoneDigits.includes(phoneDigits) || phoneDigits.includes(ticketPhoneDigits)) {
                        if (!found.some(ticket => ticket.ticketNumber === data.ticketNumber)) {
                            found.push({
                                ...data,
                                numero: parseInt(numero)
                            });
                        }
                    }
                });

                if (found.length === 0) {
                    alert('No se encontr√≥ ning√∫n ticket con ese n√∫mero de tel√©fono');
                    return;
                }

                setFoundTickets(found);
            };

            const showFoundTicket = (ticket) => {
                setCurrentTicket(ticket.numero);
                setShowSearchTicketModal(false);
                setShowTicket(true);
            };

            // Funci√≥n para abrir el modal de pago desde el ticket
            const openPaymentFromTicket = () => {
                if (!currentTicket) return;
                
                const ticketInfo = ticketData[currentTicket];
                if (!ticketInfo || ticketInfo.estado !== 'reservado') {
                    alert('‚ùå Solo puedes pagar n√∫meros que est√©n en estado RESERVADO');
                    return;
                }
                
                setSelectedReservedNumber(currentTicket);
                setUpdatePaymentData({
                    metodoPago: '',
                    comprobanteFile: null
                });
                setShowUpdatePaymentModal(true);
                setShowTicket(false); // Cerrar el modal del ticket
            };

            const downloadTicketImage = () => {
                if (!currentTicket || !ticketData[currentTicket]) return;

                const userInfo = ticketData[currentTicket];
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 1000;
                const ctx = canvas.getContext('2d');

                // Fondo gradiente
                const gradient = ctx.createLinearGradient(0, 0, 0, 1000);
                gradient.addColorStop(0, '#7c3aed');
                gradient.addColorStop(1, '#4c1d95');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 800, 1000);

                // Contenido del ticket
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 40px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üéüÔ∏è TICKET OFICIAL üéüÔ∏è', 400, 80);

                ctx.font = 'bold 30px Arial';
                ctx.fillText('RIFA $1.000.000', 400, 140);

                // Informaci√≥n del cliente
                ctx.fillStyle = '#fbbf24';
                ctx.font = '24px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Cliente: ${userInfo.nombre} ${userInfo.apellido || ''}`, 50, 220);
                ctx.fillText(`Tel√©fono: ${userInfo.telefono}`, 50, 270);
                ctx.fillText(`Ticket No: ${userInfo.ticketNumber}`, 50, 320);

                // N√∫meros
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 28px Arial';
                ctx.fillText('Tus N√∫meros:', 50, 400);
                
                const numeros = userInfo.numeros || [currentTicket];
                let yPos = 450;
                numeros.forEach((num, index) => {
                    if (index > 0 && index % 5 === 0) yPos += 60;
                    const xPos = 50 + (index % 5) * 140;
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillRect(xPos, yPos, 120, 50);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 30px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(num.toString().padStart(3, '0'), xPos + 60, yPos + 35);
                });

                // Estado
                yPos += 100;
                ctx.textAlign = 'left';
                let estadoColor = '#f59e0b';
                let estadoTexto = '‚è≥ RESERVADO';
                
                if (userInfo.estado === 'pagado') {
                    estadoColor = '#10b981';
                    estadoTexto = '‚úÖ PAGADO';
                } else if (userInfo.estado === 'pendiente_verificacion') {
                    estadoColor = '#f59e0b';
                    estadoTexto = '‚è≥ PENDIENTE VERIFICACI√ìN';
                }
                
                ctx.fillStyle = estadoColor;
                ctx.font = 'bold 26px Arial';
                ctx.fillText(`Estado: ${estadoTexto}`, 50, yPos);

                // Info adicional
                yPos += 80;
                ctx.fillStyle = '#ffffff';
                ctx.font = '22px Arial';
                ctx.fillText(`Premio: $1.000.000 COP`, 50, yPos);
                ctx.fillText(`Valor: $${appSettings.precioNumero * numeros.length} COP`, 50, yPos + 40);
                ctx.fillText(`Sorteo: ${appSettings.loteria}`, 50, yPos + 80);
                ctx.fillText(`Fecha: ${appSettings.fechaSorteo}`, 50, yPos + 120);

                // Footer
                ctx.fillStyle = '#fbbf24';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Franklin Monsalve - +57 3197118858', 400, yPos + 180);

                // Convertir a imagen y descargar
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ticket_${userInfo.ticketNumber}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            };

            const openUpdatePaymentModal = (num) => {
                setSelectedReservedNumber(num);
                setUpdatePaymentData({
                    metodoPago: '',
                    comprobanteFile: null
                });
                setShowUpdatePaymentModal(true);
            };

            const updateReservationToPaid = async (e) => {
                processPaymentWithApp(e, true);
            };

            const toggleNumber = (num) => {
                // Verificar si el n√∫mero est√° expirado
                if (expiredReservations.has(num)) {
                    alert(`‚ö†Ô∏è El n√∫mero ${num.toString().padStart(3, '0')} estaba reservado pero ha expirado. Ahora est√° disponible.`);
                    const newExpired = new Set(expiredReservations);
                    newExpired.delete(num);
                    setExpiredReservations(newExpired);
                    return;
                }
                
                if (soldNumbers.has(num) || reservedNumbers.has(num) || pendingVerificationNumbers.has(num)) {
                    alert(`‚ùå El n√∫mero ${num.toString().padStart(3, '0')} ya est√° ocupado`);
                    return;
                }
                
                const newSelected = new Set(selectedNumbers);
                if (newSelected.has(num)) {
                    newSelected.delete(num);
                } else {
                    if (newSelected.size >= 5) {
                        alert('‚ùå M√°ximo 5 n√∫meros por persona');
                        return;
                    }
                    newSelected.add(num);
                }
                setSelectedNumbers(newSelected);
            };

            const openForm = () => {
                if (selectedNumbers.size === 0) {
                    alert('‚ùå Por favor selecciona al menos un n√∫mero');
                    return;
                }
                setShowForm(true);
                setPendingNumbers(new Set([...pendingNumbers, ...selectedNumbers]));
                setFormData({
                    nombre: '',
                    apellido: '',
                    telefono: '',
                    email: '',
                    metodoPago: '',
                    comprobanteFile: null
                });
                setPaymentConfirmed(false);
            };

            const handleFormChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };

            const handleUpdatePaymentChange = (e) => {
                setUpdatePaymentData({
                    ...updatePaymentData,
                    [e.target.name]: e.target.value
                });
            };

            const handleFileChange = (e, isUpdate = false) => {
                const file = e.target.files[0];
                if (file) {
                    if (isUpdate) {
                        setUpdatePaymentData(prev => ({
                            ...prev,
                            comprobanteFile: file
                        }));
                    } else {
                        setFormData(prev => ({
                            ...prev,
                            comprobanteFile: file
                        }));
                    }
                }
            };

            const abrirNequi = () => {
                openPaymentApp('nequi', appSettings.precioNumero * selectedNumbers.size);
            };

            const generarTicketWhatsApp = (numeros, userData, estado) => {
                const nombreCompleto = `${userData.nombre} ${userData.apellido || ''}`.trim();
                let estadoTexto = 'RESERVADO';
                if (estado === 'pagado') estadoTexto = 'PAGADO';
                if (estado === 'pendiente_verificacion') estadoTexto = 'PENDIENTE VERIFICACI√ìN';
                
                const numerosTexto = Array.from(numeros).map(num => num.toString().padStart(3, '0')).join(', ');
                const fechaLimite = new Date(appSettings.fechaLimitePago).toLocaleString('es-CO', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const message = `üéüÔ∏è *TICKET OFICIAL - RIFA $1.000.000* üéüÔ∏è\n\n` +
                    `üë§ *Cliente:* ${nombreCompleto}\n` +
                    `üì± *Tel√©fono:* ${userData.telefono}\n` +
                    `üìß *Email:* ${userData.email || 'No proporcionado'}\n\n` +
                    `üéØ *N√∫meros Asignados:* ${numerosTexto}\n` +
                    `üé´ *Ticket No:* ${userData.ticketNumber}\n` +
                    `üìã *Estado:* ${estadoTexto}\n` +
                    (estado === 'reservado' || estado === 'pendiente_verificacion' ? `‚è∞ *Fecha L√≠mite Pago:* ${fechaLimite}\n\n` : '\n') +
                    `üí∞ *Premio:* $1.000.000 COP\n` +
                    `üíµ *Valor Total:* ${appSettings.precioNumero * numeros.size} COP\n` +
                    `üé≤ *Sorteo:* ${appSettings.loteria}\n` +
                    `üìÖ *Fecha Sorteo:* ${appSettings.fechaSorteo}\n\n` +
                    `üèÜ *Organiza:* Franklin Monsalve\n` +
                    `üìû *Contacto:* +57 3197118858\n\n` +
                    `‚úÖ *TICKET REGISTRADO OFICIALMENTE*\n` +
                    `¬°Mucha suerte! üçÄ`;

                return message;
            };

            const submitPaymentForm = async (e) => {
                processPaymentWithApp(e, false);
            };

            const reserveNumber = async (e) => {
                e.preventDefault();
                
                // Validar campos obligatorios
                if (!formData.nombre || !formData.telefono || !formData.email) {
                    alert('‚ùå Por favor completa todos los campos obligatorios (Nombre, Tel√©fono y Email)');
                    return;
                }

                const ticketNumber = `TK-${ticketCounter.toString().padStart(5, '0')}`;
                const ticketInfo = {
                    ...formData,
                    fecha: new Date().toLocaleString('es-CO'),
                    numeros: Array.from(selectedNumbers),
                    estado: 'reservado',
                    ticketNumber,
                    timestamp: new Date().getTime(),
                    verificadoPorAdmin: false
                };

                const newTicketData = { ...ticketData };
                const newReserved = new Set([...reservedNumbers, ...selectedNumbers]);

                selectedNumbers.forEach(num => {
                    newTicketData[num] = ticketInfo;
                });

                setTicketData(newTicketData);
                setReservedNumbers(newReserved);
                setSelectedNumbers(new Set());
                setPendingNumbers(new Set());
                setShowForm(false);
                setPaymentConfirmed(true);

                const reservedObj = {};
                selectedNumbers.forEach(num => { reservedObj[num] = true; });
                
                await db.collection('rifa').doc('reserved').set(reservedObj, { merge: true });
                await db.collection('rifa').doc('tickets').set(newTicketData);
                await db.collection('rifa').doc('metadata').set({ ticketCounter: ticketCounter + 1 }, { merge: true });

                setTicketCounter(ticketCounter + 1);
                
                procesarAccionCliente(selectedNumbers, ticketInfo, 'reservado');
            };

            const procesarAccionCliente = (numeros, userData, estado) => {
                sendToFranklinWhatsApp(numeros, userData, estado);
                sendConfirmationWhatsApp(numeros, userData, estado);
                setCurrentTicket(Array.from(numeros)[0]);
                setShowTicket(true);
            };

            const sendConfirmationWhatsApp = (numeros, userData, estado) => {
                const nombreCompleto = `${userData.nombre} ${userData.apellido || ''}`;
                let estadoTexto = 'RESERVADO';
                if (estado === 'pagado') estadoTexto = 'PAGADO';
                if (estado === 'pendiente_verificacion') estadoTexto = 'PENDIENTE DE VERIFICACI√ìN';
                
                const numerosTexto = Array.from(numeros).map(num => num.toString().padStart(3, '0')).join(', ');
                const fechaLimite = new Date(appSettings.fechaLimitePago).toLocaleString('es-CO', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const message = `üéüÔ∏è *CONFIRMACI√ìN DE BOLETA - RIFA $1.000.000* üéüÔ∏è\n\n` +
                    `¬°Hola ${nombreCompleto}! Tu boleta ha sido registrada con √©xito.\n\n` +
                    `üë§ *Titular:* ${nombreCompleto}\n` +
                    `üéØ *Tus N√∫meros:* ${numerosTexto}\n` +
                    `üé´ *Ticket No:* ${userData.ticketNumber}\n` +
                    `üìã *Estado:* ${estadoTexto}\n` +
                    (estado === 'reservado' || estado === 'pendiente_verificacion' ? `‚è∞ *Fecha L√≠mite Pago:* ${fechaLimite}\n\n` : '\n') +
                    (estado === 'reservado' ? `‚ö†Ô∏è *IMPORTANTE:* Recuerda realizar el pago antes de la fecha l√≠mite para participar. N√∫mero que no se paga no juega.\n\n` : '') +
                    (estado === 'pendiente_verificacion' ? `‚è≥ *Tu pago est√° en verificaci√≥n:* El administrador revisar√° tu comprobante en las pr√≥ximas horas.\n\n` : '') +
                    `¬°Mucha suerte! üçÄ`;
                window.open(`https://wa.me/57${userData.telefono}?text=${encodeURIComponent(message)}`, '_blank');
            };

            const sendToFranklinWhatsApp = (numeros, userData, estado) => {
                const nombreCompleto = `${userData.nombre} ${userData.apellido || ''}`;
                const metodoPagoText = userData.metodoPago ? {
                    'nequi': 'üì± Nequi', 
                    'efectivo': 'üíµ Efectivo', 
                    'transferencia': 'üì≤ Transferencia',
                    'bancolombia': 'üè¶ Bancolombia'
                }[userData.metodoPago] : 'SOLO RESERVA';

                const numerosTexto = Array.from(numeros).map(num => num.toString().padStart(3, '0')).join(', ');

                let estadoAdminText = '';
                if (estado === 'reservado') estadoAdminText = 'üìÖ RESERVA CONFIRMADA';
                if (estado === 'pendiente_verificacion') estadoAdminText = 'üîî PAGO PENDIENTE DE VERIFICACI√ìN';

                const message = `üéüÔ∏è *NUEVA ${estado.toUpperCase()} DE RIFA* üéüÔ∏è\n\n` +
                    `üë§ *Cliente:* ${nombreCompleto}\n` +
                    `üì± *Tel√©fono:* ${userData.telefono}\n` +
                    `üìß *Email:* ${userData.email || 'No proporcionado'}\n` +
                    `üí∞ *M√©todo de Pago:* ${metodoPagoText}\n` +
                    `üïí *Fecha:* ${new Date().toLocaleString('es-CO')}\n\n` +
                    `üéØ *N√∫meros:* ${numerosTexto}\n` +
                    `üé´ *Ticket No:* ${userData.ticketNumber}\n` +
                    `üí∞ *Premio:* $1.000.000 COP\n` +
                    `üíµ *Valor Total:* ${appSettings.precioNumero * numeros.size} COP\n\n` +
                    `${estadoAdminText}`;

                window.open(`https://wa.me/573197118858?text=${encodeURIComponent(message)}`, '_blank');
            };

            const cancelForm = () => {
                setShowForm(false);
                setPendingNumbers(new Set([...pendingNumbers].filter(n => !selectedNumbers.has(n))));
            };

            const shareClientTicket = () => {
                if (!currentTicket) return;
                
                const userInfo = ticketData[currentTicket] || {};
                const nombreCompleto = userInfo.nombre + (userInfo.apellido ? ' ' + userInfo.apellido : '') || 'Cliente';
                const numeros = userInfo.numeros || [currentTicket];
                const numerosTexto = numeros.map(num => num.toString().padStart(3, '0')).join(', ');
                
                const message = `üéüÔ∏è *BOLETA OFICIAL - RIFA $1.000.000* üéüÔ∏è\n\n` +
                    `üë§ *Titular:* ${nombreCompleto}\n` +
                    `üì± *Tel√©fono:* ${userInfo.telefono || 'Registrado'}\n\n` +
                    `üéØ *Mis N√∫meros:* ${numerosTexto}\n` +
                    `üí∞ *Premio:* $1.000.000 COP\n` +
                    `üíµ *Valor:* ${appSettings.precioNumero * numeros.length} COP\n` +
                    `üé≤ *Sorteo:* ${appSettings.loteria}\n` +
                    `üìÖ *Fecha:* ${appSettings.fechaSorteo}\n\n` +
                    `üèÜ *Organiza:* Franklin Monsalve\n` +
                    `üìû *Contacto:* +57 3197118858\n\n` +
                    `‚úÖ *BOLETA REGISTRADA OFICIALMENTE*\n` +
                    `¬°Mucha suerte! üçÄ`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            };

            const openAdminPanel = () => {
                setShowAdminPanel(true);
                setAdminPassword('');
            };

            const handleAdminLogin = (e) => {
                e.preventDefault();
                if (adminPassword === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    setShowAdminPanel(false);
                    localStorage.setItem('rifaAdmin', 'true');
                    alert('‚úÖ Acceso de administrador concedido');
                } else {
                    alert('‚ùå Contrase√±a incorrecta');
                    setAdminPassword('');
                }
            };

            // Funci√≥n para verificar un pago pendiente
            const verifyPayment = async (num) => {
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede verificar pagos');
                    return;
                }

                if (confirm(`¬øConfirmar que el pago del n√∫mero ${num.toString().padStart(3, '0')} es v√°lido?`)) {
                    try {
                        const ticketInfo = ticketData[num];
                        const updatedTicketInfo = {
                            ...ticketInfo,
                            estado: 'pagado',
                            verificadoPorAdmin: true,
                            fechaVerificacion: new Date().toLocaleString('es-CO'),
                            timestampVerificacion: new Date().getTime()
                        };

                        const newTicketData = { ...ticketData, [num]: updatedTicketInfo };
                        const newSold = new Set([...soldNumbers, num]);
                        const newPendingVerification = new Set(pendingVerificationNumbers);
                        newPendingVerification.delete(num);

                        setTicketData(newTicketData);
                        setSoldNumbers(newSold);
                        setPendingVerificationNumbers(newPendingVerification);

                        localStorage.setItem('rifaSoldNumbers', JSON.stringify([...newSold]));
                        localStorage.setItem('rifaTicketData', JSON.stringify(newTicketData));

                        await db.collection('rifa').doc('numbers').set({ [num]: true }, { merge: true });
                        await db.collection('rifa').doc('tickets').set({ [num]: updatedTicketInfo }, { merge: true });

                        setLastSale({
                            numero: num,
                            cliente: ticketInfo.nombre + (ticketInfo.apellido ? ' ' + ticketInfo.apellido : ''),
                            telefono: ticketInfo.telefono,
                            metodoPago: ticketInfo.metodoPago,
                            timestamp: new Date().getTime(),
                            tipo: 'verificacion_aprobada'
                        });

                        // Notificar al cliente
                        const confirmationMessage = `üéüÔ∏è *PAGO VERIFICADO - RIFA $1.000.000* üéüÔ∏è\n\n` +
                            `¬°Hola ${ticketInfo.nombre}! Tu pago ha sido verificado y confirmado.\n\n` +
                            `üë§ *Titular:* ${ticketInfo.nombre} ${ticketInfo.apellido || ''}\n` +
                            `üéØ *Tu N√∫mero:* ${num.toString().padStart(3, '0')}\n` +
                            `üé´ *Ticket No:* ${ticketInfo.ticketNumber}\n` +
                            `üìã *Estado:* ‚úÖ PAGADO Y CONFIRMADO\n\n` +
                            `¬°Mucha suerte en el sorteo! üçÄ`;

                        window.open(`https://wa.me/57${ticketInfo.telefono}?text=${encodeURIComponent(confirmationMessage)}`, '_blank');

                        alert('‚úÖ Pago verificado exitosamente');

                    } catch (error) {
                        console.error('Error verificando pago:', error);
                        alert('‚ùå Error al verificar el pago');
                    }
                }
            };

            // Funci√≥n para rechazar un pago
            const rejectPayment = async (num) => {
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede rechazar pagos');
                    return;
                }

                const motivo = prompt('Ingresa el motivo del rechazo:');
                if (!motivo) return;

                try {
                    const ticketInfo = ticketData[num];
                    const updatedTicketInfo = {
                        ...ticketInfo,
                        estado: 'reservado',
                        verificadoPorAdmin: false,
                        motivoRechazo: motivo,
                        fechaRechazo: new Date().toLocaleString('es-CO')
                    };

                    const newTicketData = { ...ticketData, [num]: updatedTicketInfo };
                    const newReserved = new Set([...reservedNumbers, num]);
                    const newPendingVerification = new Set(pendingVerificationNumbers);
                    newPendingVerification.delete(num);

                    setTicketData(newTicketData);
                    setReservedNumbers(newReserved);
                    setPendingVerificationNumbers(newPendingVerification);

                    localStorage.setItem('rifaTicketData', JSON.stringify(newTicketData));

                    await db.collection('rifa').doc('reserved').set({ [num]: true }, { merge: true });
                    await db.collection('rifa').doc('tickets').set({ [num]: updatedTicketInfo }, { merge: true });

                    // Notificar al cliente
                    const rejectionMessage = `üéüÔ∏è *PAGO RECHAZADO - RIFA $1.000.000* üéüÔ∏è\n\n` +
                        `Hola ${ticketInfo.nombre}. Lamentamos informarte que tu comprobante de pago fue rechazado.\n\n` +
                        `üë§ *Titular:* ${ticketInfo.nombre} ${ticketInfo.apellido || ''}\n` +
                        `üéØ *Tu N√∫mero:* ${num.toString().padStart(3, '0')}\n` +
                        `üé´ *Ticket No:* ${ticketInfo.ticketNumber}\n` +
                        `üìã *Estado:* ‚ùå PAGO RECHAZADO\n` +
                        `üìù *Motivo:* ${motivo}\n\n` +
                        `Puedes intentar realizar el pago nuevamente con un comprobante v√°lido.\n\n` +
                        `¬°Gracias por tu comprensi√≥n!`;

                    window.open(`https://wa.me/57${ticketInfo.telefono}?text=${encodeURIComponent(rejectionMessage)}`, '_blank');

                    alert('‚úÖ Pago rechazado y notificado al cliente');

                } catch (error) {
                    console.error('Error rechazando pago:', error);
                    alert('‚ùå Error al rechazar el pago');
                }
            };

            const openClearDataModal = () => {
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede realizar esta acci√≥n');
                    return;
                }
                setShowClearDataModal(true);
                setClearDataConfirmation('');
            };

            const clearAllData = async (e) => {
                e.preventDefault();
                
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede realizar esta acci√≥n');
                    return;
                }

                if (clearDataConfirmation !== 'CONFIRMAR') {
                    alert('‚ùå Por favor escribe "CONFIRMAR" para proceder');
                    return;
                }

                try {
                    localStorage.removeItem('rifaSoldNumbers');
                    localStorage.removeItem('rifaTicketData');
                    setSoldNumbers(new Set());
                    setTicketData({});
                    setSelectedNumbers(new Set());
                    setLastSale(null);
                    setReservedNumbers(new Set());
                    setWinnerNumber(null);
                    setDrawExecuted(false);
                    setTicketCounter(1);
                    setExpiredReservations(new Set());
                    setPendingVerificationNumbers(new Set());
                    
                    await db.collection('rifa').doc('numbers').set({});
                    await db.collection('rifa').doc('tickets').set({});
                    await db.collection('rifa').doc('reserved').set({});
                    await db.collection('rifa').doc('draw').set({});
                    await db.collection('rifa').doc('metadata').set({ ticketCounter: 1 });
                    
                    setShowClearDataModal(false);
                    setClearDataConfirmation('');
                    
                    alert('‚úÖ Todos los datos han sido limpiados exitosamente');
                } catch (error) {
                    console.error('Error limpiando datos:', error);
                    alert('‚ùå Error al limpiar los datos. Int√©ntalo de nuevo.');
                }
            };

            const generatePDFReport = () => {
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede generar reportes');
                    return;
                }

                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('REPORTE DE RIFA - $1.000.000', 105, 15, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleString('es-CO')}`, 105, 22, { align: 'center' });
                doc.text(`Sorteo: ${appSettings.loteria} - ${appSettings.fechaSorteo}`, 105, 28, { align: 'center' });
                
                const tableData = [];
                
                const uniqueTickets = {};
                Object.entries(ticketData).forEach(([numero, data]) => {
                    if (data.ticketNumber && !uniqueTickets[data.ticketNumber]) {
                        uniqueTickets[data.ticketNumber] = {
                            ...data,
                            numeros: [parseInt(numero)]
                        };
                    } else if (data.ticketNumber && uniqueTickets[data.ticketNumber]) {
                        uniqueTickets[data.ticketNumber].numeros.push(parseInt(numero));
                    }
                });

                Object.values(uniqueTickets).sort((a, b) => a.ticketNumber.localeCompare(b.ticketNumber)).forEach(ticket => {
                    const numerosTexto = ticket.numeros.map(num => num.toString().padStart(3, '0')).join(', ');
                    let estado = '';
                    if (ticket.estado === 'pagado') estado = 'PAGADO';
                    if (ticket.estado === 'reservado') estado = 'RESERVADO';
                    if (ticket.estado === 'pendiente_verificacion') estado = 'PENDIENTE VERIF.';
                    
                    tableData.push([
                        ticket.ticketNumber,
                        `${ticket.nombre} ${ticket.apellido || ''}`.trim(),
                        numerosTexto,
                        ticket.telefono,
                        ticket.email || '',
                        estado,
                        ticket.metodoPago || 'SOLO RESERVA',
                        ticket.verificadoPorAdmin ? '‚úÖ' : '‚ùå'
                    ]);
                });
                
                doc.autoTable({
                    startY: 35,
                    head: [['Ticket', 'Cliente', 'N√∫meros', 'Tel√©fono', 'Email', 'Estado', 'M√©todo Pago', 'Verificado']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [79, 70, 229],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    columnStyles: {
                        0: { cellWidth: 18 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 25 },
                        5: { cellWidth: 15 },
                        6: { cellWidth: 18 },
                        7: { cellWidth: 12 }
                    }
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Total vendidos: ${soldNumbers.size}`, 14, finalY);
                doc.text(`Total reservados: ${reservedNumbers.size}`, 14, finalY + 6);
                doc.text(`Pendientes verificaci√≥n: ${pendingVerificationNumbers.size}`, 14, finalY + 12);
                doc.text(`Disponibles: ${100 - soldNumbers.size - reservedNumbers.size - pendingVerificationNumbers.size}`, 14, finalY + 18);
                doc.text(`Reservas expiradas: ${expiredReservations.size}`, 14, finalY + 24);
                
                doc.save(`reporte_rifa_${new Date().toISOString().split('T')[0]}.pdf`);
            };

            const openDrawPanel = () => {
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede realizar el sorteo');
                    return;
                }
                setShowDrawPanel(true);
            };

            const executeDraw = async () => {
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede realizar el sorteo');
                    return;
                }

                if (soldNumbers.size === 0) {
                    alert('‚ùå No hay n√∫meros vendidos para realizar el sorteo');
                    return;
                }

                if (confirm('¬øEst√°s seguro de realizar el sorteo? ¬°Esta acci√≥n no se puede deshacer!')) {
                    let counter = 0;
                    const interval = setInterval(() => {
                        const randomNum = Math.floor(Math.random() * 100);
                        setWinnerNumber(randomNum);
                        counter++;
                        
                        if (counter > 20) {
                            clearInterval(interval);
                            const soldArray = Array.from(soldNumbers);
                            const winner = soldArray[Math.floor(Math.random() * soldArray.length)];
                            setWinnerNumber(winner);
                            setDrawExecuted(true);
                            
                            db.collection('rifa').doc('draw').set({ winner });
                            
                            alert(`üéâ ¬°SORTEO REALIZADO! El n√∫mero ganador es: ${winner.toString().padStart(3, '0')}`);
                        }
                    }, 100);
                }
            };

            const logoutAdmin = () => {
                setIsAdmin(false);
                localStorage.setItem('rifaAdmin', 'false');
                setShowAdminPanel(false);
                alert('üîí Sesi√≥n de administrador cerrada');
            };

            const openSettingsModal = () => {
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede modificar la configuraci√≥n');
                    return;
                }
                setShowSettingsModal(true);
            };

            const saveSettings = async (e) => {
                e.preventDefault();
                
                if (!isAdmin) {
                    alert('‚ùå Solo el administrador puede modificar la configuraci√≥n');
                    return;
                }

                try {
                    // Convertir fecha l√≠mite a timestamp si se modifica
                    let fechaLimitePago = appSettings.fechaLimitePago;
                    if (typeof appSettings.fechaLimitePago === 'string') {
                        fechaLimitePago = new Date(appSettings.fechaLimitePago).getTime();
                    }
                    
                    const settingsToSave = {
                        ...appSettings,
                        fechaLimitePago
                    };
                    
                    await db.collection('rifa').doc('settings').set(settingsToSave, { merge: true });
                    localStorage.setItem('rifaSettings', JSON.stringify(settingsToSave));
                    setAppSettings(settingsToSave);
                    setShowSettingsModal(false);
                    alert('‚úÖ Configuraci√≥n guardada exitosamente');
                } catch (error) {
                    console.error('Error guardando configuraci√≥n:', error);
                    alert('‚ùå Error al guardar la configuraci√≥n');
                }
            };

            const numbers = Array.from({ length: 100 }, (_, i) => i);

            // Obtener n√∫meros pagados
            const paidNumbers = Array.from(soldNumbers).filter(num => 
                ticketData[num] && ticketData[num].estado === 'pagado'
            );

            return (
                <div className="p-3 sm:p-4">
                    <div className="max-w-6xl mx-auto mb-4">
                        <div className={`${
                            syncStatus.includes('CONECTADO') ? 'bg-green-500/20 border-green-400' : 
                            'bg-yellow-500/20 border-yellow-400'
                        } backdrop-blur-lg rounded-xl p-3 border text-center`}>
                            <p className="text-white font-bold text-sm">{syncStatus}</p>
                        </div>
                    </div>

                    {lastSale && (
                        <div className="max-w-6xl mx-auto mb-4">
                            <div className={`${
                                lastSale.tipo === 'verificacion_aprobada' ? 'bg-green-500/20 border-green-400' :
                                lastSale.tipo === 'pendiente_verificacion' ? 'bg-yellow-500/20 border-yellow-400' :
                                'bg-blue-500/20 border-blue-400'
                            } backdrop-blur-lg rounded-xl p-3 border animate-pulse`}>
                                <p className="text-white font-bold text-center text-sm sm:text-base">
                                    {lastSale.tipo === 'verificacion_aprobada' ? '‚úÖ VERIFICACI√ìN: ' : 
                                     lastSale.tipo === 'pendiente_verificacion' ? '‚è≥ PENDIENTE: ' : 
                                     lastSale.tipo === 'actualizaci√≥n_pendiente' ? 'üîÑ ACTUALIZACI√ìN: ' : 'üéâ ¬°NUEVA VENTA! '}
                                    N√∫mero {lastSale.numero?.toString().padStart(3, '0')} - {lastSale.cliente}
                                </p>
                            </div>
                        </div>
                    )}

                    <div className="max-w-6xl mx-auto mb-6 sm:mb-8">
                        <div className="bg-white/10 backdrop-blur-lg rounded-2xl sm:rounded-3xl p-4 sm:p-6 border border-white/20 shadow-2xl">
                            <div className="text-center">
                                <h1 className="text-2xl sm:text-4xl font-bold text-white mb-2">üé∞ Gran Rifa üé∞</h1>
                                <div className="bg-gradient-to-r from-yellow-400 to-yellow-600 text-black font-bold text-xl sm:text-3xl py-2 sm:py-3 px-4 sm:px-6 rounded-xl sm:rounded-2xl inline-block mb-3">
                                    $1.000.000
                                </div>
                                <p className="text-white/90 text-sm sm:text-base mb-4">Sorteo: {appSettings.loteria} - {appSettings.fechaSorteo}</p>
                                <div className="grid grid-cols-2 sm:grid-cols-5 gap-3 sm:gap-4 max-w-md mx-auto">
                                    <div className="bg-green-500/20 backdrop-blur-sm rounded-xl p-3 border border-green-400/30">
                                        <p className="text-white font-bold text-lg sm:text-xl">{soldNumbers.size}</p>
                                        <p className="text-white/80 text-xs sm:text-sm">Pagados</p>
                                    </div>
                                    <div className="bg-yellow-500/20 backdrop-blur-sm rounded-xl p-3 border border-yellow-400/30">
                                        <p className="text-white font-bold text-lg sm:text-xl">{reservedNumbers.size}</p>
                                        <p className="text-white/80 text-xs sm:text-sm">Reservados</p>
                                    </div>
                                    <div className="bg-orange-500/20 backdrop-blur-sm rounded-xl p-3 border border-orange-400/30">
                                        <p className="text-white font-bold text-lg sm:text-xl">{pendingVerificationNumbers.size}</p>
                                        <p className="text-white/80 text-xs sm:text-sm">Pendientes</p>
                                    </div>
                                    <div className="bg-blue-500/20 backdrop-blur-sm rounded-xl p-3 border border-blue-400/30">
                                        <p className="text-white font-bold text-lg sm:text-xl">{100 - soldNumbers.size - reservedNumbers.size - pendingVerificationNumbers.size}</p>
                                        <p className="text-white/80 text-xs sm:text-sm">Disponibles</p>
                                    </div>
                                    <div className="bg-purple-500/20 backdrop-blur-sm rounded-xl p-3 border border-purple-400/30">
                                        <p className="text-white font-bold text-lg sm:text-xl">${appSettings.precioNumero.toLocaleString()}</p>
                                        <p className="text-white/80 text-xs sm:text-sm">Por n√∫mero</p>
                                    </div>
                                </div>
                                {expiredReservations.size > 0 && (
                                    <div className="mt-4 bg-red-500/20 backdrop-blur-sm rounded-xl p-3 border border-red-400/30">
                                        <p className="text-white font-bold text-sm">
                                            ‚ö†Ô∏è {expiredReservations.size} reserva(s) expirada(s) - Ya disponibles
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto mb-6 sm:mb-8">
                        <div className="bg-white/10 backdrop-blur-lg rounded-2xl sm:rounded-3xl p-4 sm:p-6 border border-white/20 shadow-2xl">
                            <h2 className="text-xl sm:text-2xl font-bold text-white mb-4 text-center">Selecciona tus n√∫meros</h2>
                            <p className="text-white/80 text-center mb-4 text-sm sm:text-base">M√°ximo 5 n√∫meros por persona</p>
                            
                            <div className="grid responsive-grid gap-2 sm:gap-3 mb-6">
                                {numbers.map(num => {
                                    const isSelected = selectedNumbers.has(num);
                                    const isSold = soldNumbers.has(num);
                                    const isReserved = reservedNumbers.has(num);
                                    const isPending = pendingNumbers.has(num);
                                    const isExpired = expiredReservations.has(num);
                                    const isPendingVerification = pendingVerificationNumbers.has(num);
                                    
                                    let bgColor = 'bg-white/10 hover:bg-white/20';
                                    let textColor = 'text-white';
                                    let borderColor = 'border-white/20';
                                    let statusText = '';
                                    
                                    if (isSelected) {
                                        bgColor = 'bg-blue-500 hover:bg-blue-600';
                                        borderColor = 'border-blue-400';
                                    } else if (isSold) {
                                        bgColor = 'bg-green-500/30';
                                        borderColor = 'border-green-400/50';
                                        statusText = '‚úÖ';
                                    } else if (isReserved) {
                                        bgColor = 'bg-yellow-500/30';
                                        borderColor = 'border-yellow-400/50';
                                        statusText = '‚è≥';
                                    } else if (isPendingVerification) {
                                        bgColor = 'pending-verification';
                                        borderColor = 'border-orange-400';
                                        statusText = 'üîî';
                                    } else if (isExpired) {
                                        bgColor = 'expired-reservation';
                                        borderColor = 'border-red-400';
                                        statusText = '‚ö†Ô∏è';
                                    } else if (isPending) {
                                        bgColor = 'bg-purple-500/30';
                                        borderColor = 'border-purple-400/50';
                                    }
                                    
                                    return (
                                        <button
                                            key={num}
                                            onClick={() => toggleNumber(num)}
                                            disabled={isSold || isReserved || isPendingVerification}
                                            className={`responsive-button rounded-xl border-2 font-bold transition-all duration-200 ${bgColor} ${borderColor} ${textColor} relative`}
                                        >
                                            {num.toString().padStart(3, '0')}
                                            {statusText && (
                                                <span className="absolute -top-1 -right-1 text-xs">{statusText}</span>
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            <div className="flex flex-col sm:flex-row gap-3 justify-center items-center">
                                <button
                                    onClick={openForm}
                                    disabled={selectedNumbers.size === 0}
                                    className={`px-6 py-3 rounded-xl font-bold text-white transition-all duration-200 ${
                                        selectedNumbers.size === 0 
                                            ? 'bg-gray-500 cursor-not-allowed' 
                                            : 'bg-green-500 hover:bg-green-600 shadow-lg'
                                    }`}
                                >
                                    Comprar N√∫meros ({selectedNumbers.size})
                                </button>
                                
                                <button
                                    onClick={openSearchTicketModal}
                                    className="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold transition-all duration-200 shadow-lg"
                                >
                                    üéüÔ∏è Ver Mi Ticket
                                </button>
                                
                                {!isAdmin && (
                                    <button
                                        onClick={openAdminPanel}
                                        className="px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold transition-all duration-200 shadow-lg"
                                    >
                                        Admin
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto mb-6 sm:mb-8">
                        <div className="bg-white/10 backdrop-blur-lg rounded-2xl sm:rounded-3xl p-4 sm:p-6 border border-white/20 shadow-2xl">
                            <h2 className="text-xl sm:text-2xl font-bold text-white mb-4 text-center">Informaci√≥n de Pago</h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-sm rounded-xl p-4 border border-green-400/30">
                                    <h3 className="text-white font-bold text-lg mb-2">üì± Nequi</h3>
                                    <p className="text-white/90 text-sm mb-2">319 7118858</p>
                                    <p className="text-white/80 text-xs">Franklin Monsalve</p>
                                    <button 
                                        onClick={abrirNequi}
                                        className="mt-3 w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold transition-all duration-200"
                                    >
                                        Pagar con Nequi
                                    </button>
                                </div>
                                
                                <div className="bg-gradient-to-br from-blue-500/20 to-indigo-500/20 backdrop-blur-sm rounded-xl p-4 border border-blue-400/30">
                                    <h3 className="text-white font-bold text-lg mb-2">üè¶ Bancolombia</h3>
                                    <p className="text-white/90 text-sm mb-2">Ahorros: 311-720846-32</p>
                                    <p className="text-white/80 text-xs">Franklin Monsalve</p>
                                    <button 
                                        onClick={() => openPaymentApp('bancolombia', appSettings.precioNumero * selectedNumbers.size)}
                                        className="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold transition-all duration-200"
                                    >
                                        Pagar con Bancolombia
                                    </button>
                                </div>
                            </div>
                            <div className="mt-4 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 backdrop-blur-sm rounded-xl p-4 border border-yellow-400/30">
                                <h3 className="text-white font-bold text-lg mb-2">üíµ Efectivo</h3>
                                <p className="text-white/90 text-sm">Pago en efectivo directamente con Franklin Monsalve</p>
                                <p className="text-white/80 text-xs mt-1">Contacto: +57 3197118858</p>
                                <button 
                                    onClick={() => openPaymentApp('efectivo', appSettings.precioNumero * selectedNumbers.size)}
                                    className="mt-3 w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg font-bold transition-all duration-200"
                                >
                                    Coordinar Pago
                                </button>
                            </div>
                            <div className="mt-4 bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-sm rounded-xl p-4 border border-purple-400/30">
                                <h3 className="text-white font-bold text-lg mb-2">üìÖ Reserva de N√∫meros</h3>
                                <p className="text-white/90 text-sm">Puedes reservar n√∫meros sin pago inmediato</p>
                                <p className="text-white/80 text-xs mt-1">Fecha l√≠mite de pago: {new Date(appSettings.fechaLimitePago).toLocaleString('es-CO', {
                                    day: '2-digit',
                                    month: 'long',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</p>
                            </div>
                        </div>
                    </div>

                    {isAdmin && (
                        <div className="max-w-6xl mx-auto mb-6 sm:mb-8">
                            <div className="bg-red-500/20 backdrop-blur-lg rounded-2xl sm:rounded-3xl p-4 sm:p-6 border border-red-400/30 shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl sm:text-2xl font-bold text-white">Panel de Administrador</h2>
                                    <button
                                        onClick={logoutAdmin}
                                        className="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-bold transition-all duration-200"
                                    >
                                        üîí Cerrar Sesi√≥n
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-4">
                                    <button
                                        onClick={generatePDFReport}
                                        className="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold transition-all duration-200"
                                    >
                                        üìä Generar Reporte
                                    </button>
                                    
                                    <button
                                        onClick={openDrawPanel}
                                        className="bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-bold transition-all duration-200"
                                    >
                                        üé≤ Realizar Sorteo
                                    </button>
                                    
                                    <button
                                        onClick={openClearDataModal}
                                        className="bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold transition-all duration-200"
                                    >
                                        üóëÔ∏è Limpiar Datos
                                    </button>
                                    
                                    <button
                                        onClick={openSettingsModal}
                                        className="bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-lg font-bold transition-all duration-200"
                                    >
                                        ‚öôÔ∏è Configuraci√≥n
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                    <div className="bg-black/30 rounded-xl p-4">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="text-white font-bold">N√∫meros Reservados</h3>
                                            <span className="bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">{reservedNumbers.size}</span>
                                        </div>
                                        <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 max-h-40 overflow-y-auto">
                                            {Array.from(reservedNumbers).map(num => {
                                                const ticketInfo = ticketData[num];
                                                return (
                                                    <div key={num} className="bg-yellow-500/20 border border-yellow-400/50 rounded-lg p-2">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white font-bold text-sm">{num.toString().padStart(3, '0')}</span>
                                                            <button 
                                                                onClick={() => openUpdatePaymentModal(num)}
                                                                className="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded"
                                                            >
                                                                Pagar
                                                            </button>
                                                        </div>
                                                        <p className="text-white/80 text-xs truncate">{ticketInfo?.nombre || 'Sin info'}</p>
                                                    </div>
                                                );
                                            })}
                                            {reservedNumbers.size === 0 && (
                                                <p className="text-white/60 text-sm col-span-5 text-center">No hay n√∫meros reservados</p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-black/30 rounded-xl p-4">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="text-white font-bold">Pendientes Verificaci√≥n</h3>
                                            <span className="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">{pendingVerificationNumbers.size}</span>
                                        </div>
                                        <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 max-h-40 overflow-y-auto">
                                            {Array.from(pendingVerificationNumbers).map(num => {
                                                const ticketInfo = ticketData[num];
                                                return (
                                                    <div key={num} className="pending-verification border border-orange-400 rounded-lg p-2">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white font-bold text-sm">{num.toString().padStart(3, '0')}</span>
                                                            <div className="flex gap-1">
                                                                <button 
                                                                    onClick={() => verifyPayment(num)}
                                                                    className="bg-green-500 hover:bg-green-600 text-white text-xs px-1 py-0.5 rounded"
                                                                >
                                                                    ‚úÖ
                                                                </button>
                                                                <button 
                                                                    onClick={() => rejectPayment(num)}
                                                                    className="bg-red-500 hover:bg-red-600 text-white text-xs px-1 py-0.5 rounded"
                                                                >
                                                                    ‚ùå
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <p className="text-white/80 text-xs truncate">{ticketInfo?.nombre || 'Sin info'}</p>
                                                        <p className="text-white/60 text-xs">{ticketInfo?.metodoPago}</p>
                                                        {ticketInfo?.comprobanteURL && (
                                                            <a href={ticketInfo.comprobanteURL} target="_blank" className="text-blue-400 text-xs underline">
                                                                Ver comprobante
                                                            </a>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {pendingVerificationNumbers.size === 0 && (
                                                <p className="text-white/60 text-sm col-span-5 text-center">No hay pagos pendientes</p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-black/30 rounded-xl p-4">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="text-white font-bold">N√∫meros Pagados</h3>
                                            <span className="bg-green-500 text-white text-xs px-2 py-1 rounded-full">{paidNumbers.length}</span>
                                        </div>
                                        <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 max-h-40 overflow-y-auto">
                                            {paidNumbers.map(num => {
                                                const ticketInfo = ticketData[num];
                                                return (
                                                    <div key={num} className="bg-green-500/20 border border-green-400/50 rounded-lg p-2">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-white font-bold text-sm">{num.toString().padStart(3, '0')}</span>
                                                            <span className="text-xs px-1 py-0.5 rounded bg-green-500 text-white">
                                                                ‚úÖ
                                                            </span>
                                                        </div>
                                                        <p className="text-white/80 text-xs truncate">{ticketInfo?.nombre || 'Sin info'}</p>
                                                        <p className="text-white/60 text-xs">{ticketInfo?.metodoPago}</p>
                                                    </div>
                                                );
                                            })}
                                            {paidNumbers.length === 0 && (
                                                <p className="text-white/60 text-sm col-span-5 text-center">No hay n√∫meros pagados</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL DE INSTRUCCIONES DE PAGO */}
                    {showPaymentInstructions && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl sm:rounded-3xl p-4 sm:p-6 w-full max-w-md border border-white/20 shadow-2xl">
                                <h2 className="text-xl sm:text-2xl font-bold text-white mb-4 text-center">üì± Completa tu Pago</h2>
                                
                                <div className="bg-white/10 rounded-xl p-4 mb-4">
                                    <div className="text-center mb-4">
                                        <div className="text-4xl mb-2">
                                            {currentPaymentData.metodoPago === 'nequi' ? 'üì±' :
                                             currentPaymentData.metodoPago === 'bancolombia' ? 'üè¶' :
                                             currentPaymentData.metodoPago === 'efectivo' ? 'üíµ' : 'üì≤'}
                                        </div>
                                        <h3 className="text-white font-bold text-lg">
                                            {currentPaymentData.metodoPago === 'nequi' ? 'Pago por Nequi' :
                                             currentPaymentData.metodoPago === 'bancolombia' ? 'Pago por Bancolombia' :
                                             currentPaymentData.metodoPago === 'efectivo' ? 'Pago en Efectivo' : 'Transferencia'}
                                        </h3>
                                    </div>

                                    <div className="space-y-3 text-white/80 text-sm">
                                        <div className="flex justify-between">
                                            <span>N√∫meros:</span>
                                            <span className="font-bold">
                                                {currentPaymentData.numeros.map(n => n.toString().padStart(3, '0')).join(', ')}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>Total a pagar:</span>
                                            <span className="font-bold text-green-400">${currentPaymentData.total.toLocaleString()}</span>
                                        </div>
                                        
                                        {currentPaymentData.metodoPago === 'nequi' && (
                                            <div className="bg-yellow-500/20 rounded-lg p-3 mt-3">
                                                <p className="font-bold text-yellow-300 text-center">319 7118858</p>
                                                <p className="text-center text-xs">Franklin Monsalve</p>
                                            </div>
                                        )}
                                        
                                        {currentPaymentData.metodoPago === 'bancolombia' && (
                                            <div className="bg-blue-500/20 rounded-lg p-3 mt-3">
                                                <p className="font-bold text-blue-300 text-center">311-720846-32</p>
                                                <p className="text-center text-xs">Ahorros - Franklin Monsalve</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-yellow-500/20 rounded-xl p-4 mb-4 border border-yellow-400/30">
                                    <h4 className="text-white font-bold mb-2 text-center">üìã Instrucciones:</h4>
                                    <ol className="text-white/80 text-sm space-y-2 list-decimal list-inside">
                                        <li>Se abri√≥ la app de {currentPaymentData.metodoPago} para que realices el pago</li>
                                        <li>Si no se abri√≥ autom√°ticamente, usa la informaci√≥n mostrada arriba</li>
                                        <li>Realiza el pago por <strong>${currentPaymentData.total.toLocaleString()}</strong></li>
                                        <li>Toma captura del comprobante</li>
                                        <li>Regresa a esta pantalla y sube el comprobante</li>
                                    </ol>
                                </div>

                                <div className="bg-white/10 rounded-xl p-4 mb-4">
                                    <label className="text-white font-bold mb-2 block">Sube tu comprobante de pago:</label>
                                    <input
                                        type="file"
                                        accept="image/*,.pdf"
                                        onChange={(e) => {
                                            const file = e.target.files[0];
                                            if (file) {
                                                completePaymentAfterApp(file);
                                            }
                                        }}
                                        className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                    />
                                    <p className="text-white/60 text-xs mt-2">Sube captura del pago (imagen o PDF)</p>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowPaymentInstructions(false);
                                            if (currentPaymentData.isUpdate) {
                                                setShowUpdatePaymentModal(true);
                                            } else {
                                                setShowForm(true);
                                            }
                                        }}
                                        className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                    >
                                        ‚Ü©Ô∏è Volver
                                    </button>
                                    <button
                                        onClick={() => {
                                            // Re-abrir la app de pago
                                            openPaymentApp(currentPaymentData.metodoPago, currentPaymentData.total);
                                        }}
                                        className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                    >
                                        üîÑ Abrir App
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* LOS DEM√ÅS MODALES SE MANTIENEN IGUAL */}
                    {showSearchTicketModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl sm:rounded-3xl p-4 sm:p-6 w-full max-w-md border border-white/20 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl sm:text-2xl font-bold text-white mb-4 text-center">üîç Buscar Mi Ticket</h2>
                                
                                <div className="mb-4">
                                    <label className="block text-white text-sm font-medium mb-2">
                                        Ingresa tu n√∫mero de tel√©fono:
                                    </label>
                                    <input
                                        type="tel"
                                        value={searchPhone}
                                        onChange={(e) => setSearchPhone(e.target.value)}
                                        placeholder="Ej: 3001234567"
                                        className="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <button
                                    onClick={searchTicketByPhone}
                                    className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold transition-all duration-200 mb-4"
                                >
                                    üîç Buscar
                                </button>

                                {foundTickets.length > 0 && (
                                    <div className="space-y-3 mb-4">
                                        <h3 className="text-white font-bold text-center">Tickets Encontrados:</h3>
                                        {foundTickets.map((ticket, index) => (
                                            <div key={index} className="bg-white/10 rounded-xl p-4 border border-white/20">
                                                <p className="text-white font-bold mb-2">
                                                    {ticket.nombre} {ticket.apellido || ''}
                                                </p>
                                                <p className="text-white/80 text-sm mb-2">
                                                    üì± {ticket.telefono}
                                                </p>
                                                <p className="text-white/80 text-sm mb-2">
                                                    üé´ {ticket.ticketNumber}
                                                </p>
                                                <p className="text-white/80 text-sm mb-2">
                                                    üéØ N√∫meros: {ticket.numeros?.map(n => n.toString().padStart(3, '0')).join(', ')}
                                                </p>
                                                <p className="text-white/80 text-sm mb-3">
                                                    üìã Estado: {ticket.estado === 'pagado' ? '‚úÖ PAGADO' : 
                                                               ticket.estado === 'pendiente_verificacion' ? '‚è≥ PENDIENTE VERIFICACI√ìN' : 'üìÖ RESERVADO'}
                                                </p>
                                                <button
                                                    onClick={() => showFoundTicket(ticket)}
                                                    className="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold transition-all duration-200"
                                                >
                                                    Ver Ticket Completo
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <button
                                    onClick={() => {
                                        setShowSearchTicketModal(false);
                                        setSearchPhone('');
                                        setFoundTickets([]);
                                    }}
                                    className="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                >
                                    ‚ùå Cerrar
                                </button>
                            </div>
                        </div>
                    )}

                    {showAdminPanel && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl sm:rounded-3xl p-4 sm:p-6 w-full max-w-md border border-white/20 shadow-2xl">
                                <h2 className="text-xl sm:text-2xl font-bold text-white mb-4 text-center">Acceso de Administrador</h2>
                                <form onSubmit={handleAdminLogin}>
                                    <input
                                        type="password"
                                        value={adminPassword}
                                        onChange={(e) => setAdminPassword(e.target.value)}
                                        placeholder="Contrase√±a"
                                        className="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
                                    />
                                    <div className="flex gap-3">
                                        <button
                                            type="submit"
                                            className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                        >
                                            Acceder
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setShowAdminPanel(false)}
                                            className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                        >
                                            Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showForm && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl sm:rounded-3xl p-4 sm:p-6 w-full max-w-md border border-white/20 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl sm:text-2xl font-bold text-white mb-4 text-center">Completar Compra</h2>
                                
                                <div className="bg-white/10 rounded-xl p-4 mb-4">
                                    <p className="text-white font-bold text-center mb-2">Tus N√∫meros Seleccionados:</p>
                                    <div className="flex flex-wrap gap-2 justify-center">
                                        {Array.from(selectedNumbers).map(num => (
                                            <span key={num} className="bg-blue-500 text-white px-3 py-1 rounded-lg font-bold">
                                                {num.toString().padStart(3, '0')}
                                            </span>
                                        ))}
                                    </div>
                                    <p className="text-white text-center mt-2">
                                        Total a pagar: <span className="font-bold">${appSettings.precioNumero * selectedNumbers.size}</span>
                                    </p>
                                </div>

                                {!paymentConfirmed ? (
                                    <form onSubmit={submitPaymentForm}>
                                        <div className="space-y-3">
                                            <div>
                                                <label className="text-white text-sm font-medium required-field">Nombre</label>
                                                <input
                                                    type="text"
                                                    name="nombre"
                                                    placeholder="Tu nombre completo *"
                                                    value={formData.nombre}
                                                    onChange={handleFormChange}
                                                    className="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    required
                                                />
                                            </div>
                                            <div>
                                                <label className="text-white text-sm font-medium">Apellido</label>
                                                <input
                                                    type="text"
                                                    name="apellido"
                                                    placeholder="Tu apellido"
                                                    value={formData.apellido}
                                                    onChange={handleFormChange}
                                                    className="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-white text-sm font-medium required-field">Tel√©fono</label>
                                                <input
                                                    type="tel"
                                                    name="telefono"
                                                    placeholder="Tu n√∫mero de tel√©fono *"
                                                    value={formData.telefono}
                                                    onChange={handleFormChange}
                                                    className="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    required
                                                />
                                            </div>
                                            <div>
                                                <label className="text-white text-sm font-medium required-field">Email</label>
                                                <input
                                                    type="email"
                                                    name="email"
                                                    placeholder="Tu correo electr√≥nico *"
                                                    value={formData.email}
                                                    onChange={handleFormChange}
                                                    className="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    required
                                                />
                                            </div>
                                            
                                            <div className="bg-white/10 rounded-xl p-3">
                                                <label className="text-white font-bold mb-2 block required-field">M√©todo de Pago:</label>
                                                <select
                                                    name="metodoPago"
                                                    value={formData.metodoPago}
                                                    onChange={handleFormChange}
                                                    className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    required
                                                >
                                                    <option value="">Selecciona m√©todo de pago *</option>
                                                    <option value="nequi">üì± Nequi</option>
                                                    <option value="bancolombia">üè¶ Bancolombia</option>
                                                    <option value="efectivo">üíµ Efectivo</option>
                                                    <option value="transferencia">üì≤ Transferencia</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div className="form-buttons mt-6">
                                            <button
                                                type="submit"
                                                disabled={isUploading}
                                                className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition-all duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
                                            >
                                                {isUploading ? 'Procesando...' : 'üí≥ Ir a Pagar'}
                                            </button>
                                            <button
                                                type="button"
                                                onClick={reserveNumber}
                                                className="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                            >
                                                üìÖ Solo Reservar
                                            </button>
                                            <button
                                                type="button"
                                                onClick={cancelForm}
                                                className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                            >
                                                ‚ùå Cancelar
                                            </button>
                                        </div>
                                    </form>
                                ) : (
                                    <div className="text-center">
                                        <div className="text-green-400 text-6xl mb-4">‚úÖ</div>
                                        <h3 className="text-white text-xl font-bold mb-2">¬°Solicitud Enviada!</h3>
                                        <p className="text-white/80 mb-4">Tu comprobante ha sido enviado para verificaci√≥n.</p>
                                        <button
                                            onClick={() => setShowForm(false)}
                                            className="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-xl font-bold transition-all duration-200"
                                        >
                                            Continuar
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {showUpdatePaymentModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl sm:rounded-3xl p-4 sm:p-6 w-full max-w-md border border-white/20 shadow-2xl">
                                <h2 className="text-xl sm:text-2xl font-bold text-white mb-4 text-center">Confirmar Pago de Reserva</h2>
                                
                                <div className="bg-white/10 rounded-xl p-4 mb-4">
                                    <p className="text-white text-center">
                                        N√∫mero: <span className="font-bold text-yellow-400">{selectedReservedNumber && selectedReservedNumber.toString().padStart(3, '0')}</span>
                                    </p>
                                    {selectedReservedNumber && ticketData[selectedReservedNumber] && (
                                        <p className="text-white text-center">
                                            Cliente: <span className="font-bold">{ticketData[selectedReservedNumber].nombre} {ticketData[selectedReservedNumber].apellido || ''}</span>
                                        </p>
                                    )}
                                </div>

                                <form onSubmit={updateReservationToPaid}>
                                    <div className="bg-white/10 rounded-xl p-3 mb-4">
                                        <label className="text-white font-bold mb-2 block required-field">M√©todo de Pago:</label>
                                        <select
                                            name="metodoPago"
                                            value={updatePaymentData.metodoPago}
                                            onChange={handleUpdatePaymentChange}
                                            className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required
                                        >
                                            <option value="">Selecciona m√©todo de pago *</option>
                                            <option value="nequi">üì± Nequi</option>
                                            <option value="bancolombia">üè¶ Bancolombia</option>
                                            <option value="efectivo">üíµ Efectivo</option>
                                            <option value="transferencia">üì≤ Transferencia</option>
                                        </select>
                                    </div>

                                    <div className="form-buttons">
                                        <button
                                            type="submit"
                                            disabled={isUploading}
                                            className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition-all duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
                                        >
                                            {isUploading ? 'Procesando...' : 'üí≥ Ir a Pagar'}
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setShowUpdatePaymentModal(false)}
                                            className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                        >
                                            ‚ùå Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showTicket && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl sm:rounded-3xl p-4 sm:p-6 w-full max-w-md border-4 border-white shadow-2xl">
                                <div className="text-center">
                                    <h2 className="text-2xl sm:text-3xl font-bold text-black mb-4">üéüÔ∏è TU TICKET üéüÔ∏è</h2>
                                    
                                    {currentTicket !== null && ticketData[currentTicket] && (
                                        <div className="bg-white/90 rounded-xl p-4 mb-4 text-black">
                                            <p className="font-bold text-lg mb-2">{ticketData[currentTicket].nombre} {ticketData[currentTicket].apellido || ''}</p>
                                            <p className="mb-1">üì± {ticketData[currentTicket].telefono}</p>
                                            {ticketData[currentTicket].email && <p className="mb-1">üìß {ticketData[currentTicket].email}</p>}
                                            <p className="mb-1">üé´ {ticketData[currentTicket].ticketNumber}</p>
                                            <p className="mb-1">üìÖ {ticketData[currentTicket].fecha}</p>
                                            <div className="mt-3">
                                                <p className="font-bold mb-1">Tus N√∫meros:</p>
                                                <div className="flex flex-wrap gap-2 justify-center">
                                                    {ticketData[currentTicket].numeros?.map(num => (
                                                        <span key={num} className="bg-blue-500 text-white px-3 py-1 rounded-lg font-bold">
                                                            {num.toString().padStart(3, '0')}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="mt-3 p-2 rounded-lg ${
                                                ticketData[currentTicket].estado === 'pagado' ? 'bg-green-100' :
                                                ticketData[currentTicket].estado === 'pendiente_verificacion' ? 'bg-orange-100' : 'bg-yellow-100'
                                            }">
                                                <p className="font-bold ${
                                                    ticketData[currentTicket].estado === 'pagado' ? 'text-green-700' :
                                                    ticketData[currentTicket].estado === 'pendiente_verificacion' ? 'text-orange-700' : 'text-yellow-700'
                                                }">
                                                    Estado: {
                                                        ticketData[currentTicket].estado === 'pagado' ? '‚úÖ PAGADO' :
                                                        ticketData[currentTicket].estado === 'pendiente_verificacion' ? '‚è≥ PENDIENTE VERIFICACI√ìN' : 'üìÖ RESERVADO'
                                                    }
                                                </p>
                                                {(ticketData[currentTicket].estado === 'reservado' || ticketData[currentTicket].estado === 'pendiente_verificacion') && (
                                                    <p className="text-xs ${
                                                        ticketData[currentTicket].estado === 'pendiente_verificacion' ? 'text-orange-700' : 'text-yellow-700'
                                                    } mt-1">
                                                        Fecha l√≠mite de pago: {new Date(appSettings.fechaLimitePago).toLocaleString('es-CO', {
                                                            day: '2-digit',
                                                            month: 'long',
                                                            year: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className={`grid gap-3 ${
                                        currentTicket && ticketData[currentTicket] && ticketData[currentTicket].estado === 'reservado' 
                                        ? 'grid-cols-2 sm:grid-cols-4' 
                                        : 'grid-cols-1 sm:grid-cols-3'
                                    }`}>
                                        {/* Bot√≥n de PAGAR - Solo aparece para reservados */}
                                        {currentTicket && ticketData[currentTicket] && ticketData[currentTicket].estado === 'reservado' && (
                                            <button
                                                onClick={openPaymentFromTicket}
                                                className="bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                            >
                                                üí≥ Pagar
                                            </button>
                                        )}
                                        
                                        <button
                                            onClick={downloadTicketImage}
                                            className="bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                        >
                                            üíæ Descargar
                                        </button>
                                        <button
                                            onClick={shareClientTicket}
                                            className="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                        >
                                            üì§ Compartir
                                        </button>
                                        <button
                                            onClick={() => setShowTicket(false)}
                                            className="bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold transition-all duration-200"
                                        >
                                            ‚ùå Cerrar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* LOS DEM√ÅS MODALES SE MANTIENEN IGUAL */}
                    {showDrawPanel && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            {/* Contenido del modal de sorteo */}
                        </div>
                    )}

                    {showClearDataModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            {/* Contenido del modal de limpiar datos */}
                        </div>
                    )}

                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            {/* Contenido del modal de configuraci√≥n */}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<TalonarioRifa />, document.getElementById('app'));
    </script>
</body>
</html>
